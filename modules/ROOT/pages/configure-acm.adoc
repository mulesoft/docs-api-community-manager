= Configure ACM
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../assets/images/

Follow these steps to configure API Community Manager (ACM).

NOTE: Installing, updating or configuring ACM must be done by a user account with the *System Administrator* profile in the ACM Salesforce organization.

NOTE: If your Anypoint Platform organization is https://docs.mulesoft.com/eu-control-plane/platform-access-eu[hosted in the EU region, role=external, window=_blank] you must replace all occurrences of the `anypoint.mulesoft.com` domain with `eu1.anypoint.mulesoft.com` in all the steps in this section.

* <<create-and-authenticate-the-external-data-source>>
** <<create-a-connected-app>>
*** <<create-a-connected-app-with-the-user-interface>>
*** <<create-a-connected-app-with-an-api-call>>
** <<create-your-authentication-provider>>
** <<authorize-and-authenticate-your-external-data-source>>
* <<enable-acm-control-panel>>
* <<update-your-user-role-and-permissions>>
* <<communities>>

** <<create-a-community>>
** <<customize-your-community>>
** <<enable-forums>>
** <<define-moderation-rules-for-forums>>
** <<enable-cms>>
** <<enable-crm-content>>
** <<enable-chatter-tracking>>
** <<publish-your-community>>

* <<users>>

** <<configure-member-user-access>>
** <<configure-sharing-settings>>
** <<configure-members>>
** <<configure-guest-user-access>>
** <<enable-guest-user-registration-as-members>>
*** <<add-self-register-custom-component-to-register-page>>
*** <<assign-a-profile-for-your-community-members>>
*** <<create-an-account-for-your-community>>
*** <<configure-your-login-and-registration-pages>>
*** <<set-up-an-admin-approval-process-for-new-user-creation>>
**** <<create-the-approval-process>>
**** <<create-an-approval-step>>
**** <<create-a-final-approval-action>>
**** <<activate-the-approval-process>>

* <<set-up-user-impersonation>>
** <<configure-salesforce-as-a-saml-identity-provider>>
** <<set-up-custom-attributes>>
** <<configure-external-identity-in-your-anypoint-organization>>
** <<configure-and-authorize-the-odata-bridge-to-perform-impersonation>>
** <<mapping-community-user-to-anypoint-role>>
** <<re-authenticate-the-external-data-source>>

* <<configure-eu-account>>
* <<configure-search>>
** <<create-custom-object-tab>>
** <<enable-global-search>>
** <<add-custom-object-search>>
** <<customize-search-layouts>>


== Create and Authenticate the External Data Source [[create-and-authenticate-the-external-data-source]]

The external data source specifies how ACM components and data objects interact securely with your MuleSoft Anypoint organization.

=== Create a Connected App [[create-a-connected-app]]

You can perform this step either with the user interface or with an API call.

==== Create a Connected App with the User Interface [[create-a-connected-app-with-the-user-interface]]

To create a connected app with the user interface, in Anypoint Platform, navigate to *Access Management* -> *Applications* -> *Create New Application*, and provide the following information:

. *Application Name*: Enter a name.
. *Redirect URIs*: This URL can be found in the Authentication Provider configuration. Navigate
to *Salesforce Setup* -> *Auth. Providers* -> *Anypoint* -> *Callback URL*.
. *User Grant Types*
.. *Authorization Code*: Checked.
.. *Refresh Token*: Checked.
.. *Full Access*: Checked
.. *Background Access*: Checked.
. Select *Create Application*.

==== Create a Connected App with an API Call [[create-a-connected-app-with-an-api-call]]

To create a connected app with an API call, follow this example using `cURL`.

Get an authorization token from the platform:

----
    curl --silent https://anypoint.mulesoft.com/accounts/login -XPOST \
      -d 'username=<anypoint username>&password=<anypoint password>'
----

This returns a response like this:

----
    {
      "access_token": "5242XXXX-XXXX-XXXX-XXXX-XXXXXXXXfec7",
      "token_type": "bearer",
      "redirectUrl": "/home/"
    }
----

Note the `access_token` value.

Use the next `cURL` example to register an external client in Anypoint for OpenID authentication.

Replace the access token in the authorization header with the `access_token` value.

Replace `[YourOrgDomain]` with your Salesforce organization domain name. Find the domain name by logging in to your Salesforce organization, selecting *Setup*, and selecting the section *My Domain*.

----
    curl -X POST \
      https://anypoint.mulesoft.com/accounts/api/connectedApplications \
      -H 'Accept: */*' \
      -H 'Accept-Encoding: gzip, deflate' \
      -H 'Authorization: Bearer 5242XXXX-XXXX-XXXX-XXXX-XXXXXXXXfec7' \
      -H 'Host:anypoint.mulesoft.com' \
      -d '{"client_name":"SalesforceApp","grant_types":["authorization_code","refresh_token"],"redirect_uris":["https://[YourOrgDomain].my.salesforce.com/services/authcallback/Anypoint"],"scopes":["full","offline_access"],"public_keys":[]}'
----

The `cURL` command will return a response like this:

----
    {
      "client_id": "5fafXXXXXXXXXXXXXXXXXXXXXXXX29c9",
      "client_secret": "9509XXXXXXXXXXXXXXXXXXXXXXXXC10E",
      "client_name": "ACM Integration Client",
      "redirect_uris": [
        "https://[YourOrgDomain].my.salesforce.com/services/authcallback/Anypoint"
      ],
      "grant_types": [
        "authorization_code",
        "refresh_token"
      ],
      "public_keys": [],
      "scopes": [
        "offline_access",
        "full"
      ],
      "enabled": true,
      "owner_org_id": "f377XXXX-XXXX-XXXX-XXXX-XXXXXXXX9d08",
      "as_id": "anypoint"
    }
----

Note the `client_id` and `client_secret` values.

=== Create Your Authentication Provider [[create-your-authentication-provider]]

NOTE: If your Anypoint Platform organization is hosted in the EU, change `+https://anypoint.mulesoft.com+` to `+https://eu1.anypoint.mulesoft.com+`.

. In *Setup*, search for *Auth. Providers* using the *Quick Find* box and select *Auth. Providers* -> *New*.
. In *Provider type* select *Open ID Connect*.
. Set the *Name* to `Anypoint`.
. Set the *Consumer Key* to the application ID of the Connect App created in Anypoint.
. Set the *Consumer Secret* to the application secret of the Connect App created in Anypoint.
. Set the *Authorize Endpoint URL* to `+https://anypoint.mulesoft.com/accounts/api/v2/oauth2/authorize+` .
. Set the *Token Endpoint URL* to `+https://anypoint.mulesoft.com/accounts/api/v2/oauth2/token+` .
. Set the *Default Scopes* to `full offline_access`.
. Select *Save*.

NOTE: Remember to associate the external data source with this authentication provider.

=== Authorize and Authenticate Your External Data Source [[authorize-and-authenticate-your-external-data-source]]

. Search for *External Data Source* in the *Quick Find* box and then select *External Data Sources*.
. Locate the *Exchange* item and then select *Edit*.
. Update *Identity Type* to *Named Principal*.
. Update *Authentication Protocol* to *OAuth 2.0*.
. Update *Authentication Provider* to *Anypoint*.
. Select *Save*.
. If you don't have an active session in your Anypoint Platform organization, the *Anypoint Login* page is shown. Log in to the Anypoint Platform to complete the authentication. If you already have an active session, authentication is performed without requiring a login.
. Verify the Exchange *External Data Sources* *Authentication Status* is *Authenticated*.

After authenticating the External Data Source, provide the credentials of an Anypoint Platform system user with read-only access, for components like the API Console which retrieve data directly from the Anypoint Platform APIs:

. Search for *Named Credentials* in the *Quick Find* box and then select *Named Credentials*.
. Locate the *anypoint.mulesoft* item and then select *Edit*.
. In the *Authentication* section, enter the Anypoint username and password in the *Username* and
*Password* fields, respectively, for a system user with read-only privileges in your Anypoint Platform organization.
. Select *Save*.

== Enable *ACM Control Panel* [[enable-acm-control-panel]]

The *ACM Control Panel* is the interface your community administrators and operators will use to operate your communities. It is available in the *App Launcher* where it is the first icon displayed in the main navigation bar. To ensure it is available for admin users:

. In *Setup*, search for *App Manager* using the *Quick Find* box and select *App Manager*.
. Locate the *API Community Manager* item, open the drop down menu on the right end of the row and select *Edit*.
. Select *Navigation Items* on the left panel, highlight the *ACM Administrator* item under the *Available Items* box, and use the arrow buttons to move it to the *Selected Items* box. Select *Save*.
. Select *Back* at the top right.
. Log out and log back in to your Salesforce organization.
. Open the *App Launcher* and select *API Community Manager*.
. Verify that the *ACM Control Panel* is displayed correctly. In the *Application Launcher*, open *ACM Administrator*. If you see a message that you have not created a community, the actions in this step were done correctly.

== Update Your User Role and Permissions [[update-your-user-role-and-permissions]]

. In *Setup*, search for *Users* using the *Quick Find* box and select *Users*.
. Locate your username and select *Edit*.
. Set the *Role* for your account. This can be any role from the list, but cannot be none. If you don't see any roles in the dropdown list, refer to the Salesforce knowledge article https://help.salesforce.com/articleView?language=en_US&type=1&mode=1&id=000322715[Add roles to the role hierarchy, role=external, window=_blank] for instructions to create a role in your organization.
. Select *Salesforce CRM Content User*.
. Select *Save*.

== Communities Configuration [[communities]]

=== Create a Community [[create-a-community]]

. If you are not familiar with Communities, refer to the https://help.salesforce.com/articleView?id=networks_resources.htm&type=5[Salesforce Communities Overview, role=external, window=_blank].
. Navigate to *Setup*.
. In the *Quick Find* box, enter *All Communities* and then select *All Communities*.
. Select *New Community*. All communities templates are listed.
. Choose any of the *API Community Manager Templates* if you want to get started from an example, any of the other available templates, or *Build your own* if you want to design your community from scratch with full control of the structure and look and feel.
. On the desired template page, select *Get Started*.
. Enter a *Name* and an *optional URL suffix* for your community.
. Select *Create*. The configuration process will take a few minutes.
. When the configuration process finishes, you'll see your new community workspace. Select *Install AppExchange Package* on the top banner to install the pre-defined metrics and dashboards, and follow the installation wizard instructions. Be sure to install this package in your production organization when prompted by the wizard. You may need to re-enter your login credentials to complete the installation of this package.
. In the *Application Launcher* navigate to *ACM Administrator*, select *Community Administration*, select the *Settings* section, and select *Activate Community*.

=== Customize Your Community [[customize-your-community]]

Refer to xref:brand-intro.adoc[Brand and Customize Your API Community].

=== Enable Forums [[enable-forums]]

. In the *Application Launcher* navigate to *ACM Administrator*, select *Community Administration*, and select *Preferences* in the left panel.
. Select *Show all settings in Workspaces*.
. Select *Save* so this setting is reflected.
. Select *Allow discussion threads*.
. Select *Save*.
. Go back to the *ACM Control Panel*, and select *Manage CMS Content*.
. Select the *Topics* tab.
. Select *Navigational Topics*.
. Create as many topics as you need for your community forums and select *Save*.

=== Define Moderation Rules for Forums [[define-moderation-rules-for-forums]]

By default discussion forums are not moderated, so any member can create posts with any content and the posts become visible for other members immediately. If you want to define a basic "review/approve-all" moderation model, follow the steps below:

. In the *ACM Control Panel*, select *Manage Forums* and select *Rules*.
. Select *New* and create a *Content Rule*.
. Enter a *Name* and a *Unique Name* in the *Details* section and select *Activate Rule*.
. In the *Rule Conditions* section, select *Post* and *Comment*, and select *Review* in *Moderation Action*.
. In the *Criteria* section, move all items in *Member Criteria* from the *Available Criteria* box to the *Selected Criteria* box.
. Select *Save*.

image::forum-moderation-rule.png[Forum Moderation Rule]

IMPORTANT: Verify the *Activate Rule* check box is active when saving your changes.

You can define much more advanced moderation and review rules. You can find more information in the Salesforce Community Cloud documentation about https://help.salesforce.com/articleView?id=networks_moderator_manage_rules.htm&type=5[forum moderation rules, role=external, window=_blank].

=== Enable Salesforce CMS [[enable-cms]]

. In *Setup*, search for *Salesforce Files* using the *Quick Find* box and select *General Settings*.
. Select *Edit*.
. Select *Libraries in Salesforce Files*.
. Select *Save*.
. In *Setup*, search for *App Manager* using the *Quick Find* box and select *App Manager*.
. Locate the *Salesforce CMS* item, open the drop down menu on the right end of the row and select *Edit*.
. Select *User Profiles* on the left panel, highlight the *System Administrator* item under the *Available Profiles* box, and use the arrow buttons to move it to the *Selected Profiles* box.
. Select *Save*.
. Click *Back* at the top right.
. Open the *App Launcher* and select *Salesforce CMS*.
. Select *Create Your First Workspace*.
. In the *Name and Describe Your Workspace* step enter a *Name* for your workspace and select *Next*.
. In the *Add Destination* step, select your community in the list by clicking on the "+" sign. Select *Next*.
. In the *Add Contributors* step select *Next*.
. Confirm the information and select *Done*.

If you want to organize CMS content using Topics:

. Go to *ACM Control Panel*, select *Manage CMS Content*, and select *Topics*.
. Select the topics you want to enable to organize CMS content and select *Enable for content* in the top right.

=== Enable Salesforce CRM Content [[enable-crm-content]]

. In *Setup*, search for *Salesforce CRM* using the *Quick Find* box and select *Salesforce CRM Content*.
. Select *Enable Salesforce CRM Content*.
. Select *Save*.

=== Enable Chatter Tracking for APIs [[enable-chatter-tracking]]

Chatter tracking allows creating discussions on specific objects like APIs. To use Chatter tracking for APIs:

. In *Setup*, search for *Chatter* using the *Quick Find* box and select *Feed Tracking*.
. Select the *CommunityAPI* object.
. Select *Enable feed tracking*. You do not need to select any fields.
. Select *Save*.

=== Publish Your Community [[publish-your-community]]

. In the *ACM Control Panel*, select *Community Builder*.
. Select *Publish* on the top right corner, and select *Publish* in the *Publish Your Community* dialog.
. In a few minutes your community will be published, and you will receive an email notification including your community's public URL. You can also find your community live URL by opening the *ACM Control Panel* and selecting *Open Community*.

NOTE: To use a custom domain name, also known as a vanity domain, refer to the Salesforce knowledge article https://help.salesforce.com/articleView?id=000336819&type=1&mode=1[Run your Salesforce Community under a custom domain, role=external, window=_blank].

== Configure Profiles and Permissions [[users]]

After you create a community, you must create the different user profiles for your community guests and members, so that you can control access to and visibility of APIs and content.

=== Configure Member User Access [[configure-member-user-access]]

In this section, you create the profile for members of your community. Users that are signed-in are *members*.

. In *Setup*, search for *Users* using the *Quick Find* box and select *Profiles*.
. Select the *Customer Community Plus Login User* profile.
. Select *Clone*.
. Enter `ACM Member User` for *Profile Name*.
. Select *Save*.

Next you need to give permissions to your members' profile so that they can access APIs, create client applications and manage their details. To do this:

. Select *Edit* in the *ACM Member User* profile page.
. In the *Standard Object Permissions* section:
.. Enable *Read* permissions for:
... *Documents*
. In the *Custom Object Permissions* section:
.. Enable *Read* permissions for:
... *CommunityApi*
.. Enable *Read*, *Edit*, *Create* and *Delete* permissions for:
... *SelfRegisterUserRequests*
. In the *External Object Permissions* section:
.. Enable *Read* permissions for:
... *AnypointApiInstances*
... *AnypointApiTiers*
... *AnypointApiVersionQueries*
... *AnypointApiVersions*
.. Enable *Read*, *Edit*, *Create* and *Delete* permissions for:
... *AnypointApplications*
... *AnypointContracts*
. Select *Save*.
. Go to the *Field-Level Security* section in the *ACM Member User* profile page.
. In the *Custom Field-Level Security* section, for each of the following objects, select *View*, then *Edit*, enable the corresponding permissions as follows, and select *Save* on each:
.. Enable *Read* permissions for all fields of the objects:
... *AnypointApiInstances*
... *AnypointApiTiers*
... *AnypointApiVersionQueries*
... *AnypointApiVersion*
... *CommunityApi*
.. Enable *Read* and *Edit* permissions for:
... *AnypointApplications*
... *AnypointContracts*
... *SelfRegisterUserRequests*

=== Configure Sharing Settings [[configure-sharing-settings]]

. In *Setup*, search for *Users* using the *Quick Find* box and select *Public Groups*.
. Select *New*.
. In the *Label* field, enter `[Community Name] Public Group`.
. In the *Search* dropdown, select *Users*.
. Use the *Add* button to move `User: [Your Community Name] Site Guest User` from the *Available Members* box to the *Selected Members* box.
. Select *Save*.

In the following steps you will use the public group that you've just created.

. In *Setup*, search for *Security* using the *Quick Find* box and select *Sharing Settings*.
. Scroll to the *CommunityApi Sharing Rules* section near the bottom of the page and select *New*.
. In the *Rule Name* section, update *Label* with `[Community Name] Guest`.
. In the *Select your rule type* section, select `Based on criteria`.
. In the *Select which records to be shared* section, add the following criteria:
.. *Field*: `Community Name` *Operator*: `equals` *Value*: `[Community Name]`
.. *Field*: `Visibility` *Operator*: `equals` *Value*: `Public`
. In *Select the users to share with*: enter *Share with*: `Public Groups` and `[Community Name] Public Group`.
. In *Select the level of access for the users*, select *Read Only*.
. Select Save.
. Switch to Salesforce Classic. Select the user profile menu at top right and select *Switch to Salesforce Classic*.
. Select the plus (`+`) button at the end of the navigation menu bar.
. In the *View* dropdown, select *Content* and then select *Libraries*.
. In the *Manage Library* dropdown on the right, select *Asset Library*.
. In the *Members* section, select *Add Members*.
. In the *Edit Library Membership Wizard*, select `Public Groups` from the *Search* drop-down and add the
public group previously created with the *Add* button. Select *Next*.
. Assign the *Viewer* Permission and select *Save*.
. Switch back to the lightning Experience by selecting *Switch to Lightning Experience*.

NOTE: If you ever change the name of your community, be sure to update this setting.

=== Configure Members in Your Community [[configure-members]]

. In *Setup*, search for *Communities* using the *Quick Find* box and select *Communities Settings*.
. Scroll to *Sharing Sets* and select *New*.
. In the *Sharing Set Edit* section, update *Label* with `[Community Name] Sharing Set`. Select *Save*.
. In the *Select Profiles* section, select *ACM Member User* from *Available Profiles* and add it to *Selected Profiles*.
. In the *Select Objects* section, select *CommunityApi* from *Available Objects* and add it to *Selected Objects*.
. In the *Configure Access* section, select *Set Up* under the *Action* column.
. In the *Access Mapping for CommunityApi* page enter:
.. *Account* in the *User* dropdown.
.. *acm_pkg__Account_c* in the *Target CommunityApi* dropdown.
.. *Read Only* in the *Access Level* dropdown.
. Select *Update*.
. Select *Save*.

image::access-mapping.png[Access Mapping for CommunityApi]

=== Configure Guest User Access [[configure-guest-user-access]]

. In the *ACM Control Panel*, open *Community Builder*, and select *Settings* -> *General*.
. Select the *Public can access the community* check box.
. Navigate to the guest user profile link under the *Guest user profile* section, named *[Community Name] Profile*.
. Select *Edit*.
. In the *Standard Object Permissions* section:
.. Enable *Read* permissions for:
... *Documents*
. In the *Custom Object Permissions* section:
.. Enable *Read* permissions for:
... *CommunityApi*
.. Enable *Read*, *Edit*, *Create* and *Delete* permissions for:
... *SelfRegisterUserRequests*
. In the *External Object Permissions* section:
.. Enable *Read* permissions for:
... *AnypointApiInstances*
... *AnypointApiTiers*
... *AnypointApiVersionQueries*
... *AnypointApiVersions*
... *AnypointApplications*
... *AnypointContracts*
. Select *Save*.
. Go to the *Field-Level Security* section in the *ACM Member User* profile page.
. In the *Custom Field-Level Security* section, for each of the following objects, select *View*, then *Edit*, enable the corresponding permissions as follows, and select *Save* on each:
.. Enable *Read* permissions for all fields of the objects:
... *AnypointApiInstances*
... *AnypointApiTiers*
... *AnypointApiVersionQueries*
... *AnypointApiVersion*
... *CommunityApi*
... *AnypointApplications*
... *AnypointContracts*
.. Enable *Read* and *Edit* permissions for:
... *SelfRegisterUserRequests*


=== Enable Guest User Registration as Members [[enable-guest-user-registration-as-members]]

==== Add Self Register Component to Registration Page [[add-self-register-custom-component-to-register-page]]

The self-register component allows guest users to self-register in your community to become members. If you're not using any of the ACM out-of-the-box templates, follow these steps to use the ACM-specific self-registration component.

. In the *ACM Control Panel*, open *Community Builder* and navigate to the *Register* page in the Pages menu on the top left.
. Remove the standard *Self Registration* component by selecting the delete icon next to it.
. Navigate to *Components*, search for *Self Register* and add the component to the page.

==== Assign a Profile for Your Community Members [[assign-a-profile-for-your-community-members]]

. In the *ACM Control Panel*, open *Community Administration* and navigate to the *Members* section on the left panel.
. In the *Select Profiles* section, Select *All* in the *Search* drop-down.
. Use the *Add* button to add *ACM Member User* to the *Selected Profiles* box.
. Select *Save*.

IMPORTANT: Do not *Remove* the *System Administrator* profile from the *Selected Profiles* section. If you remove the *System Administrator* profile you will lose all access to your community.

==== Create an Account for Your Community [[create-an-account-for-your-community]]

. Navigate to *App Launcher* and select *Accounts*.
. Select *New* to create a new account.
. Enter `ACM Registered Users` in *Account Name*.
. Select *Save*.

==== Configure Your Login and Registration Pages [[configure-your-login-and-registration-pages]]

NOTE: Refer to xref:brand-intro.adoc[Brand and Customize Your API Community] to understand how to configure the look and feel of your login and registration pages.

. In the *ACM Control Panel*, open *Community Administration* and navigate to the *Login & Registration* section on the left panel.
. Scroll down to the *Registration Page Configuration* section near the bottom of the page:
.. Select *Allow external users to self-register*.
.. Select *Community Builder Page* for *Registration Page Type* and select *Register*.
.. Select *ACM Member Users* in *Profile*.
.. Select *ACM Registered Users Account* in *Account*.
. Select *Save*.

==== Set Up an Admin Approval Process for New User Creation [[set-up-an-admin-approval-process-for-new-user-creation]]

Follow these steps to set an optional approval process for self-registered users. The system will then require administrator approval before creating member accounts. If the request is approved, the new user account is created, a welcome email is sent to the new user, and the user sets a password and logs in to the community.

If you don't configure an approval process, self-registered users will become members automatically when they register.

===== Create the Approval Process [[create-the-approval-process]]

. In *Setup*, search for *Approval Processes* in the *Quick Find* box and select *Approval Processes*.
. Select *Self Register User Request* in the *Manage Approval Processes For:* drop-down.
. Select *Use Standard Setup Wizard* in the *Create New Approval Process* drop-down.
. In the wizard, enter the following information:

.. In *Step 1. Enter Name and Description*, enter the following information:
... *Process Name*: `Approve Registration`.
.. Select *Next*.

.. In *Step 2. Specify Entry Criteria*, enter the following information:
... *Field*: `SelfRegisterUserRequest: Approved`
... *Operator*: `equals`
... *Value*: `False`
.. Select *Next*.

.. In *Step 3. Specify Approver Field and Record Editability Properties*:
... In the *Record Editability Properties* section select *Administrators ONLY can edit records during the approval process*.
.. Select *Next*.

.. In *Step 4. Select Notification Templates*:
... Select *Registration Request* in the *Approval Assignment Email Template* section, under the *ACM* category in the look-up dialog.
.. Select *Next*.

.. In *Step 5. Select Fields to Display on Approval Page Layout*:
... Add *Self Register User Request Name* and *Owner* to *Selected Fields*.
... Select the *Display approval history information in addition to the fields selected above* check box.
.. Select *Next*.

.. In *Step 6. Specify Initial Submitters*:
... Add *Self Register User Request Owner* to the *Allowed Submitters* column.
.. Select *Save* and continue to the next section.

===== Create an Approval Step [[create-an-approval-step]]

. After you create the approval process in the previous section:
.. If you are prompted to add an approval step, select *Yes, I'd like to create an approval step now* and select *Go!*.
.. If you are not prompted to add an approval step:
... In *Setup*, search for *Approval Processes* in the *Quick Find* box and select *Approval Processes*.
... Select *Approve Registration* (the approval that you created in the previous section).
... In the *Approval Steps* section, select *New Approval Step*.

. In the *Step 1. Enter Name and Description* section:
.. Enter `Step 1` in *Name*.
. Select *Next*.

. In the *Step 2. Specify Step Criteria* section, select *Next*.
. In the *Step 3.  Select Assigned Approver* section:
.. Select *Let the submitter choose the approver manually*.
. Select *Save*.

===== Create a Final Approval Action [[create-a-final-approval-action]]

. After you create the Approval Step in the previous section:
.. If you are prompted to add an Approval Action, select *Yes, I'd like to create an approval action for this step now*, select *Field Update* in the dropdown, and select *Go!*.
.. If you are not prompted to add an Approval Action:
... In *Setup*, search for *Approval Processes* in the *Quick Find* box and select *Approval Processes*.
... On the *Self Register User Request: Approve Registration* page, navigate to *Final Approval Actions* and select *Add New*.
... Select *Field Update*.

. In the *Field Update Edit* section, enter the following values:
.. *Name*: `Create User`
.. *Field to update*: `Approved`
.. *Re-evaluate Workflow Rules after Field Change*: Select the check box.
.. *Checkbox Options*: `True`.

. Select *Save*.

===== Activate the Approval Process [[activate-the-approval-process]]

. On the *Approve Registration* page, select *Activate* and confirm.
. In the *ACM Control Panel*, open *Community Builder*, and select *Settings* -> *General*.
. In the *Community Builder*, navigate to the *Register* page in the pages menu and select the ACM *Self Register* component.
. Verify the *Approved Registration* and set the *Approver Id* with the *User Id* of the user you want to approve the registration requests.

To get the *User Id*:

. Navigate to Salesforce Setup.
. Search for `Users` in the *Quick Find* box and select *Users*.
. Select the user who you want to be the approver.
. The ID is contained in the URL of the User detail page you are currently
viewing. Remove the first 2 characters and paste the remaining information in
the *Approver Id* field. For example, if the unique ID is `2F0052D000001QpG1`,
paste `0052D000001QpG1` in the *Approver Id* field.

== Set Up User Impersonation [[set-up-user-impersonation]]

Impersonation links each community member to an Anypoint user. This connects the
Anypoint and community users and their client applications, so that applications are
created under the correct user, and actions in audit logs are recorded accurately.

Impersonation uses SAML, and it requires an Identity Provider (IdP) to be configured in both Anypoint Platform and Salesforce organizations. You can use Salesforce as an IdP, as described in the following sections.

=== Configure Salesforce as a SAML Identity Provider [[configure-salesforce-as-a-saml-identity-provider]]

To set up SAML in your Salesforce organization:

. In *Setup*, search for *App Manager* using the *Quick Find* box and select *App Manager*.
. Select *New Connected App* in the top right.
. Provide the following information in the *Basic Information* section:
.. *Connected App Name*: `Anypoint`.
.. *Contact Email*: Enter your email address.
. Provide the following information in the *Web App Settings* section:
.. Provide the *Start URL*: `+https://anypoint.mulesoft.com/accounts/login/<your_anypoint_domain_name>+` or the location
where you want users to be sent in the Anypoint Platform. You can find your Anypoint organization domain name by selecting *Access Management* -> *Organization* and then selecting the root organization.
.. Select *Enable SAML*.
.. Provide any string as *Entity Id*. This is also the *Audience* configuration in the Anypoint Platform.
.. Provide `+https://anypoint.mulesoft.com/accounts/login/receive-id+` in the *ACS URL*. SAML assertions are sent to this ACS URL.
.. Select *Enable Single Logout*.
.. Provide *Single Logout URL*: `+https://anypoint.mulesoft.com/accounts/logout/receive-id+`.
.. Set *Single Logout Binding* to *HTTP Post*.
.. Set *Subject Type* to *Username*.
.. Set *Name ID* Format to *unspecified nameID format*.
.. Set *Issuer* to *salesforce_org_domainname* (such as `+https://[YourOrgDomain].my.salesforce.com+`).
.. Set *IdP Certificate* to *Default IdP Certificate*.
.. Select *Save*.

=== Set Up Custom Attributes [[set-up-custom-attributes]]

By default, Salesforce does not send first name and last name attributes of users, so you must add them explicitly. To do this:

. In your connected app screen, select *Manage*.
. Scroll to *Custom Attributes*.
. Add the first name attribute:
.. Select *New*.
.. Type `firstname` in the *Attribute key* field.
.. Select *Insert Field*.
.. Select *$User >* -> *First Name* -> *Insert* -> *Save*.
. Add the last name attribute:
.. Select *New*.
.. Type `lastname` in the *Attribute key* field.
.. Click *Insert Field*.
.. Select *$User >* -> *Last Name* -> *Insert* -> *Save*.

=== Configure External Identity in Your Anypoint Organization [[configure-external-identity-in-your-anypoint-organization]]

In your connected app screen, select *Manage*. Make a note of the URIs under the *SAML Login Information* to use them in the Anypoint configuration in the following steps.

Also, select *Download metadata* and retrieve the public key in the `<ds:X509Certificate>` tag inside the XML file.

. Log in to your Anypoint organization.
. Navigate to *Access Management* -> *External Identity* -> *Identity Management* -> *SAML 2.0*.
. Set *Sign On URL* to *IdP-Initiated Login URL*.
. Set *Sign Off URL* to *Single Logout Endpoint*.
. Set *Issuer* to match the Salesforce account: `salesforce_org_domainname`.
. Set the *Public Key* to the public key extracted from the `<ds:X509Certificate>` tag in the metadata XML you downloaded.
. Set *Audience* to match the *Entity Id* you set in the Salesforce account.
. Select *Save*.

=== Configure and Authorize the ODATA Bridge to Perform Impersonation [[configure-and-authorize-the-odata-bridge-to-perform-impersonation]]

This step requires a private key or a certificate, and a keystore (JKS) containing that key or certificate.
Use the same certificate that Salesforce IDP uses.

. In *Salesforce Setup*, search for *Certificate and Key Management* using the *Quick Find* box and select *Certificate and Key Management*.
. Select *Export to Keystore* in the *Certificates* section.
. Enter a new Password.
. Select *Export*.

. Log in to your Anypoint organization
. Go to *Access Management* -> *Environments*, select *Add Environment* and provide the following information:
.. Set *Environment Name* to `ACM`.
.. Select *Production*.
.. Select *Create*.
. Go to *Users* and open your user.
.. Select *Secrets Manager*.
.. Set *Environment* to the newly created environment: `ACM`.
.. Select all permissions in *Permissions*.
.. Select the plus button.
. To apply these changes, log out and then log back in.

. Go to *Secrets Manager* and select the ACM environment using the environment switcher. Select *Create Secret Group* and enter the following information:
.. Set *Name* to *Certificates*.
.. Select *Secret Group Downloadable*.
.. Select *Save*.
.. Select *Keystore*.
.. Select *Add Keystore*.
.. Provide the following information:
... *Name*: Enter `Impersonation`.
... *Type*: Enter the type of your keystore, which is typically JKS.
... *Keystore File*: Choose your keystore file, which is typically the file you exported from Salesforce.
... *Keystore Passphrase*: Enter the exported Keystore.
... *Alias*: Choose the corresponding alias to your key or certificate.
... *Key Passphrase*: Create a new Passphrase.
... Select *Save*.
.. Select *Secret Groups*.
... Select *Finish* on the recently created secret group and confirm the operation.

For detailed information about creating secret groups and adding certificates, refer to
https://docs.mulesoft.com/anypoint-security/asm-secret-group-creation-task#create-a-secret-group[Create a Secret Group (Anypoint Platform), role=external, window=_blank].

=== Mapping Community User to Anypoint Role [[mapping-community-user-to-anypoint-role]]

. In your Anypoint Platform organization, navigate to *Access Management* and select *Roles*.
. In *Exchange Viewers*, set a new External group called `Community User` and save it.

*IMPORTANT*: If you choose to use another key or certificate for the impersonation feature,
you must add this key in the External Identity configuration on Anypoint, as shown in the following steps:

. In Anypoint, select *Access Management* -> *External Identity* -> *Edit*.
. Add your key in *Public Key*:
.. Copy the key with no line breaks.
.. After the key displayed in the *Public Key* field, add a comma (`,`) and then paste in the new key.
.. Select *Save*.

=== Re-authenticate the External Data Source [[re-authenticate-the-external-data-source]]

Re-authenticate the External Data Source as described in <<create-and-authenticate-the-external-data-source>>.

== Additional Configuration for EU Hosted Organizations [[configure-eu-account]]

If your Anypoint Platform organization is hosted in the EU, perform the following additional configuration
steps to enable access to the EU instance of the Anypoint Management Plane.

* Remote site settings: Add the new site `AnypointEu` with the URL `+https://eu1.anypoint.mulesoft.com+`.
* CSP trusted sites: Add the following sites:
** `+https://eu1.anypoint.mulesoft.com+`
** `+https://exchange2-file-upload-service-kprod-eu.s3.eu-central-1.amazonaws.com+`
** `+https://exchange2-asset-manager-kprod-eu.s3.amazonaws.com+`

== Configure Search [[configure-search]]

You can choose which objects are returned by your ACM portal's search feature.

By default, only APIs published in ACM are returned.

Other objects you can add include knowledge articles, support cases, pages, and applications.

Follow these steps to add each new searchable custom object.

=== Create a Custom Object Tab [[create-custom-object-tab]]

. In *Setup*, search for *Tab* using the *Quick Find* box and select *Custom Object Tab*.
. Click *New*.
. In the *Object* field, select the custom object you want to appear in search results, such as knowledge articles or support cases.
. Set the *Tab Style*. You can add a custom icon that will show in autocomplete search results.
. Click *Next*.
. Choose the user profiles that will be able to see the new custom tab.
. Click *Next*.
. To make the new custom tab available to ACM, check the box next to *API Community Manager*.
. Click *Done*.

// Is *Done* correct? Check UI.

=== Enable Global Search [[enable-global-search]]

. In the *ACM Control Panel*, click *Community Builder*.
. Click the paintbrush icon to open the *Theme* menu.
. Click *Theme Settings*.
. Set *Search Component* to *Global Search Box*.

=== Add Custom Object to Search [[add-custom-object-search]]

. In the *ACM Control Panel*, click *Community Builder*.
. Navigate to a page that includes a *Global Search Box* component.
. Click the *Global Search Box* component to open the *Global Search Box* configuration menu.
. Click *Add*.
. Set *Object* to the custom object you want to appear in search results.
. Click *Save*.
. (Optional) Set *Maximum Autocomplete Results*. No more than this number of autocomplete results will be visible.
. Hover over the section of the page with search results to show the blue border and *Global Search Results* component name.
. Click this *Global Search Results* component to open the *Global Search Results* configuration menu.
. Click *Add*.
. Select the custom object you want to appear in search results.
. Click *Save*.

=== Customize Search Layouts [[customize-search-layouts]]

. In *Setup*, search for *Object Manager* using the *Quick Find* box and click *Object Manager*.
. Select the custom object you want to appear in search results.
. Click *Search Layouts*.
. Set the *Search Layouts* options to customize the layout of the search results for this custom object on your portal.
